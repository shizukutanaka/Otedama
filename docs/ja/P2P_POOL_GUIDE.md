# Otedama P2Pマイニングプールガイド

## 概要

Otedama P2Pマイニングプールは、P2Poolと同様の完全分散型マイニングプールアーキテクチャを実装しています。従来の中央集権型プールに見られる単一障害点を排除し、プール運営を参加する全ノードに分散させます。

## 主な機能

- **分散型アーキテクチャ**: 中央サーバーなし、全ノードが対等
- **シェアチェーン**: ブロックチェーンベースのシェア追跡（P2Pool方式）
- **PPLNS支払い**: 公正なPay-Per-Last-N-Shares分配
- **マルチアルゴリズム対応**: Bitcoin、Litecoin、Ethereum、Moneroなど
- **低レイテンシ**: 直接的なピアツーピア作業分配
- **DoS耐性**: 攻撃に対する組み込み保護
- **ゼロトラスト**: プール運営者を信頼する必要なし

## アーキテクチャコンポーネント

### 1. シェアチェーン
- マイニングシェアのブロックチェーンを維持
- 10秒のターゲットブロック時間
- 約6時間のPPLNSウィンドウ（2160シェア）
- 自動難易度調整

### 2. P2Pネットワーク探索
- ピア探索用のKademlia式DHT
- 自動ピア評価システム
- UDP探索 + TCP接続
- ブートストラップノードサポート

### 3. 分散Stratumプロキシ
- マイナー接続用の標準stratumプロトコル
- マイナーごとの自動難易度調整
- シェア検証と伝播
- リアルタイムジョブ配信

### 4. 作業分配コーディネーター
- ブロックチェーンからブロックテンプレート取得
- コンポーネント間の作業調整
- コンセンサスベースのシェア検証
- ブロック送信処理

## クイックスタート

### 1. 設定

設定ファイル `config/p2p-pool.json` を作成:

```json
{
  "poolName": "My Otedama Pool",
  "poolAddress": "あなたのウォレットアドレス",
  "poolFee": 0.01,
  
  "blockchain": "bitcoin",
  "blockchainHost": "localhost",
  "blockchainPort": 8332,
  "blockchainUsername": "rpcuser",
  "blockchainPassword": "rpcpassword",
  
  "p2pPort": 30303,
  "stratumPort": 3333,
  
  "bootstrapNodes": [
    "seed1.otedama.pool:30303",
    "seed2.otedama.pool:30303"
  ]
}
```

### 2. プールの起動

```bash
node scripts/start-p2p-pool.js config/p2p-pool.json
```

### 3. マイナーの接続

マイニングソフトウェアを以下に接続:
```
stratum+tcp://あなたのウォレットアドレス.ワーカー名@localhost:3333
```

## サポートされているブロックチェーン

| ブロックチェーン | アルゴリズム | ステータス |
|------------|-----------|---------|
| Bitcoin | SHA-256 | ✅ サポート |
| Litecoin | Scrypt | ✅ サポート |
| Ethereum | Ethash | ✅ サポート |
| Monero | RandomX | ✅ サポート |
| Ravencoin | KawPow | ✅ サポート |
| Ergo | Autolykos2 | ✅ サポート |
| Kaspa | kHeavyHash | ✅ サポート |
| Flux | Equihash | ✅ サポート |
| Conflux | Octopus | ✅ サポート |
| Beam | BeamHash | ✅ サポート |

## ネットワークプロトコル

### メッセージタイプ

1. **シェアチェーンメッセージ**
   - `sharechain:block` - 新しいシェアチェーンブロック
   - `share:submit` - 検証用シェア送信
   - `share:verification` - シェア検証結果

2. **作業分配**
   - `template:request` - 現在のブロックテンプレート要求
   - `template:response` - ブロックテンプレートデータ
   - `template:update` - 新しいブロックテンプレートブロードキャスト

3. **ピア管理**
   - `handshake` - 初期ピア接続
   - `ping/pong` - キープアライブとレイテンシ測定
   - `peer:status` - ピア統計更新

## 支払いシステム

### PPLNS (Pay Per Last N Shares)
- ウィンドウサイズ: 2160シェア（10秒/シェアで約6時間）
- 難易度加重シェアに比例した支払い
- ブロック発見時に自動支払い
- 支払い閾値なし - 全マイナーが支払いを受ける

### シェア難易度
- マイナーごとの自動難易度調整
- ターゲット: 10秒に1シェア
- シェアフラッディング防止
- 公正な貢献追跡を保証

## セキュリティ機能

### ゼロ知識証明サポート
- マイナー用オプションのZKP認証
- プライバシー保護アイデンティティ検証
- KYCなしでコンプライアンス

### DDoS保護
- IPごとのレート制限
- シェア検証クォーラム
- ピア評価システム
- 悪意のあるピアの自動BAN

### ビザンチン障害耐性
- コンセンサスベースのシェア検証
- 複数ピア検証
- シェアチェーン再編成処理

## パフォーマンス最適化

### 低レイテンシ設計
- 直接ピアツーピア通信
- 効率的なバイナリプロトコル
- メモリプールオブジェクト
- 最適化されたシェア検証

### スケーラビリティ
- 数千のマイナーをサポート
- P2Pによる水平スケーリング
- 効率的なシェアプルーニング
- 自動ピアバランシング

## モニタリング

### 組み込みメトリクス
- プールハッシュレート
- アクティブマイナー数
- シェア統計
- ブロック発見率
- ネットワークヘルス

### APIエンドポイント
- `/api/stats` - プール統計
- `/api/miners` - アクティブマイナーリスト
- `/api/blocks` - 最近のブロック
- `/api/payments` - 支払い履歴

## トラブルシューティング

### 一般的な問題

1. **ブロックチェーンに接続できない**
   - RPC認証情報を確認
   - ブロックチェーンが同期されているか確認
   - ファイアウォール設定を確認

2. **ピアが接続しない**
   - P2Pポートが開いているか確認
   - ブートストラップノードを確認
   - ファイアウォール/NAT設定を確認

3. **マイナーが接続できない**
   - stratumポートが開いているか確認
   - マイナー設定を確認
   - stratumプロキシログを確認

### デバッグモード

デバッグログを有効化:
```json
{
  "logging": {
    "level": "debug",
    "file": "logs/debug.log"
  }
}
```

## 高度な設定

### カスタムシェアウィンドウ
```json
{
  "shareWindow": 4320,  // 12時間
  "targetShareTime": 5  // 5秒/シェア
}
```

### 複数ブートストラップノード
```json
{
  "bootstrapNodes": [
    "node1.pool.com:30303",
    "node2.pool.com:30303",
    "backup.pool.com:30303"
  ],
  "maxPeers": 200
}
```

### アルゴリズム固有の設定
```json
{
  "blockchain": "monero",
  "algorithm": {
    "variant": "randomx",
    "threads": 4
  }
}
```

## 開発

### テストの実行
```bash
npm test -- p2p-pool
```

### ソースからのビルド
```bash
npm run build
```

### 貢献
- 設計原則（Carmack、Martin、Pike）に従う
- 新機能にテストを追加
- ドキュメントを更新
- プルリクエストを送信

## FAQ

**Q: 従来のプールとの違いは？**
A: 中央サーバーなし、プール運営者を信頼する必要なし、真の分散化。

**Q: ピアが切断されたらどうなりますか？**
A: プールは残りのピアで動作を継続します。新しいピアはいつでも参加できます。

**Q: 支払いはどのように処理されますか？**
A: ブロック発見時にコインベーストランザクションに直接エンコードされます。

**Q: 複数のノードを実行できますか？**
A: はい、各ノードは異なるP2PポートとノードIDを使用する必要があります。

**Q: マイニングソフトウェアと互換性がありますか？**
A: はい、主要なマイニングソフトウェアが使用する標準stratumプロトコルをサポートしています。