<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Otedama Mining Dashboard</title>
    <meta name="description" content="Monitor your Otedama mining operations in real-time">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- External Stylesheets -->
    <link rel="stylesheet" href="/styles/base.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="stylesheet" href="/styles/dashboard.css">
    
    <!-- Preload critical assets -->
    <link rel="preload" href="/styles/base.css" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js" as="script">
</head>
<body>
    <!-- Skip to main content for accessibility -->
    <a href="#main" class="skip-link">Skip to main content</a>
    
    <div class="container dashboard-container">
        <header class="dashboard-header" role="banner">
            <h1 class="dashboard-title">Otedama Mining Dashboard</h1>
            <div class="status-indicator" role="status" aria-live="polite">
                <div class="status-dot" aria-hidden="true"></div>
                <span id="connection-status">Connected</span>
            </div>
        </header>
        
        <main id="main" role="main">
        <div class="dashboard-grid" role="region" aria-label="Mining metrics">
            <article class="metric-card" role="article" aria-labelledby="hashrate-label">
                <div class="metric-header">
                    <h2 class="metric-title" id="hashrate-label">Hashrate</h2>
                    <span class="metric-change" id="hashrate-change" aria-label="Hashrate change">--</span>
                </div>
                <div class="metric-value" id="hashrate" aria-live="polite">--</div>
                <div class="metric-subtitle" id="hashrate-trend">Loading...</div>
            </article>
            
            <article class="metric-card" role="article" aria-labelledby="efficiency-label">
                <div class="metric-header">
                    <h2 class="metric-title" id="efficiency-label">Efficiency</h2>
                    <span class="metric-change" id="efficiency-change" aria-label="Efficiency change">--</span>
                </div>
                <div class="metric-value" id="efficiency" aria-live="polite">--%</div>
                <div class="metric-subtitle" id="efficiency-shares">-- accepted / -- total</div>
            </article>
            
            <article class="metric-card" role="article" aria-labelledby="temperature-label">
                <div class="metric-header">
                    <h2 class="metric-title" id="temperature-label">Temperature</h2>
                    <span class="metric-change" id="temp-status" aria-label="Temperature status">--</span>
                </div>
                <div class="metric-value" id="temperature" aria-live="polite">--°C</div>
                <div class="metric-subtitle" id="temp-range">Min: -- / Max: --</div>
            </article>
            
            <article class="metric-card" role="article" aria-labelledby="revenue-label">
                <div class="metric-header">
                    <h2 class="metric-title" id="revenue-label">Revenue</h2>
                    <span class="metric-change" id="revenue-change" aria-label="Revenue change">--</span>
                </div>
                <div class="metric-value" id="revenue" aria-live="polite">$--</div>
                <div class="metric-subtitle" id="revenue-daily">Daily estimate: $--</div>
            </article>
        </div>
        
        <section class="chart-container" role="region" aria-label="Hashrate chart">
            <div class="chart-container__header">
                <h2 class="chart-container__title">Hashrate History</h2>
            </div>
            <canvas id="hashrate-chart" role="img" aria-label="Hashrate over time chart"></canvas>
        </section>
        
        <section role="region" aria-label="GPU Status">
            <h2 class="section-title">GPU Status</h2>
            <div class="gpu-grid" id="gpu-grid" role="list">
                <div class="loading" role="status" aria-live="polite">
                    <div class="loading__spinner" aria-hidden="true"></div>
                    <span class="loading__text">Loading GPU data...</span>
                </div>
            </div>
        </section>
        
        <section class="alerts-container" role="region" aria-label="Active alerts">
            <h2 class="alerts-container__header">Active Alerts</h2>
            <div id="alerts-list" role="list" aria-live="polite">
                <div class="empty-state">
                    <span class="empty-state__text">No active alerts</span>
                </div>
            </div>
        </section>
        
        <section class="recommendations" role="region" aria-label="Optimization recommendations">
            <h2 class="recommendations__header">Optimization Recommendations</h2>
            <div id="recommendations-list" role="list">
                <div class="empty-state">
                    <span class="empty-state__text">Analyzing performance...</span>
                </div>
            </div>
        </section>
        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // WebSocket connection
        let ws;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // Chart instance
        let hashrateChart;
        
        // Data stores
        let currentData = {};
        let chartData = {
            labels: [],
            datasets: [{
                label: 'Hashrate (MH/s)',
                data: [],
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4
            }]
        };
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            
            try {
                ws = new WebSocket(`${protocol}//${window.location.host}`);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateConnectionStatus('Connected', 'success');
                    reconnectAttempts = 0;
                    hideError();
                };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (error) {
                    console.error('Failed to parse message:', error);
                }
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateConnectionStatus('Disconnected', 'error');
                
                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    updateConnectionStatus(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
                    setTimeout(connectWebSocket, 5000);
                } else {
                    showError('Connection lost. Please refresh the page to reconnect.');
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                showError('Connection error. Trying to reconnect...');
            };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                showError('Failed to establish connection. Please check your network.');
            }
        }
        
        function handleMessage(message) {
            switch (message.type) {
                case 'initial':
                    initializeDashboard(message.data);
                    break;
                    
                case 'update':
                    updateDashboard(message.data);
                    break;
                    
                case 'alert':
                    handleAlert(message.data);
                    break;
            }
        }
        
        function initializeDashboard(data) {
            currentData = data;
            updateMetrics(data);
            updateGPUs(data.gpus || []);
            initializeChart();
        }
        
        function updateDashboard(data) {
            updateMetrics(data);
            updateChart(data.hashrate);
            updateAlerts(data.alerts || []);
        }
        
        function updateMetrics(data) {
            // Update hashrate
            const hashrateMH = data.hashrate / 1000000;
            document.getElementById('hashrate').textContent = hashrateMH.toFixed(2) + ' MH/s';
            
            // Update efficiency
            document.getElementById('efficiency').textContent = data.efficiency.toFixed(2) + '%';
            document.getElementById('efficiency-shares').textContent = 
                `${data.shares.accepted} accepted / ${data.shares.total} total`;
            
            // Update temperature
            document.getElementById('temperature').textContent = data.temperature.toFixed(1) + '°C';
            
            // Update revenue
            document.getElementById('revenue').textContent = '$' + data.revenue.toFixed(2);
            document.getElementById('revenue-daily').textContent = 
                'Daily estimate: $' + (data.revenue * 24).toFixed(2);
            
            // Update status indicators
            updateStatusIndicators(data);
        }
        
        function updateStatusIndicators(data) {
            // Temperature status
            const tempStatus = document.getElementById('temp-status');
            if (data.temperature > 80) {
                tempStatus.textContent = 'High';
                tempStatus.style.color = 'var(--color-error)';
            } else if (data.temperature > 70) {
                tempStatus.textContent = 'Normal';
                tempStatus.style.color = 'var(--color-warning)';
            } else {
                tempStatus.textContent = 'Good';
                tempStatus.style.color = 'var(--color-success)';
            }
            
            // Efficiency indicator
            const effChange = document.getElementById('efficiency-change');
            if (data.efficiency > 98) {
                effChange.textContent = '↑';
                effChange.className = 'metric-change metric-change--positive';
            } else if (data.efficiency < 95) {
                effChange.textContent = '↓';
                effChange.className = 'metric-change metric-change--negative';
            } else {
                effChange.textContent = '→';
                effChange.className = 'metric-change';
            }
        }
        
        function updateGPUs(gpus) {
            const gpuGrid = document.getElementById('gpu-grid');
            
            if (gpus.length === 0) {
                gpuGrid.innerHTML = '<div class="empty-state"><span class="empty-state__text">No GPU data available</span></div>';
                return;
            }
            
            gpuGrid.innerHTML = gpus.map((gpu, index) => `
                <article class="gpu-card" role="listitem" aria-label="GPU ${gpu.index} status">
                    <h3 class="gpu-name">GPU ${gpu.index}: ${gpu.name}</h3>
                    <dl>
                        <div class="gpu-stat">
                            <dt class="gpu-stat__label">Temperature:</dt>
                            <dd class="gpu-stat__value">${gpu.temperature}°C</dd>
                        </div>
                        <div class="gpu-stat">
                            <dt class="gpu-stat__label">Fan Speed:</dt>
                            <dd class="gpu-stat__value">${gpu.fanSpeed}%</dd>
                        </div>
                        <div class="gpu-stat">
                            <dt class="gpu-stat__label">Power:</dt>
                            <dd class="gpu-stat__value">${gpu.power}W</dd>
                        </div>
                        <div class="gpu-stat">
                            <dt class="gpu-stat__label">Memory:</dt>
                            <dd class="gpu-stat__value">${gpu.memory}%</dd>
                        </div>
                        <div class="gpu-stat">
                            <dt class="gpu-stat__label">Hashrate:</dt>
                            <dd class="gpu-stat__value">${(gpu.hashrate / 1000000).toFixed(2)} MH/s</dd>
                        </div>
                    </dl>
                </article>
            `).join('');
        }
        
        function initializeChart() {
            const ctx = document.getElementById('hashrate-chart').getContext('2d');
            hashrateChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e0e0e0'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#999'
                            }
                        },
                        y: {
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#999'
                            }
                        }
                    }
                }
            });
        }
        
        function updateChart(hashrate) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            // Add new data point
            chartData.labels.push(timeStr);
            chartData.datasets[0].data.push(hashrate / 1000000);
            
            // Keep only last 60 points
            if (chartData.labels.length > 60) {
                chartData.labels.shift();
                chartData.datasets[0].data.shift();
            }
            
            // Update chart
            hashrateChart.update('none');
        }
        
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alerts-list');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="empty-state"><span class="empty-state__text">No active alerts</span></div>';
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <article class="alert alert--${alert.severity}" role="alert" aria-labelledby="alert-${alert.id}">
                    <div class="alert__content">
                        <h3 class="alert__title" id="alert-${alert.id}">${alert.type.replace(/_/g, ' ').toUpperCase()}</h3>
                        <p class="alert__message">${alert.message}</p>
                    </div>
                    <button class="alert-dismiss" onclick="dismissAlert('${alert.id}')" aria-label="Dismiss ${alert.type} alert">
                        Dismiss
                    </button>
                </article>
            `).join('');
        }
        
        async function dismissAlert(id) {
            const alertElement = document.querySelector(`#alert-${id}`)?.closest('.alert');
            if (!alertElement) return;
            
            try {
                const response = await fetch(`/api/alerts/dismiss/${id}`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Animate removal
                    alertElement.style.transition = 'opacity 0.3s ease-out';
                    alertElement.style.opacity = '0';
                    setTimeout(() => alertElement.remove(), 300);
                } else {
                    throw new Error('Failed to dismiss alert');
                }
            } catch (error) {
                console.error('Failed to dismiss alert:', error);
                showError('Failed to dismiss alert. Please try again.');
            }
        }
        
        // Helper functions for UI updates
        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connection-status');
            const statusDot = document.querySelector('.status-dot');
            
            statusElement.textContent = status;
            statusDot.className = 'status-dot';
            
            if (type === 'error') {
                statusDot.classList.add('status-dot--error');
            } else if (type === 'warning') {
                statusDot.classList.add('status-dot--warning');
            }
        }
        
        function showError(message) {
            const container = document.querySelector('.dashboard-container');
            const existingError = document.getElementById('global-error');
            
            if (existingError) {
                existingError.querySelector('.error__message').textContent = message;
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.id = 'global-error';
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <span class="error__icon" aria-hidden="true">⚠️</span>
                    <span class="error__message">${message}</span>
                    <button class="btn btn--sm btn--ghost" onclick="hideError()" aria-label="Dismiss error">×</button>
                `;
                container.insertBefore(errorDiv, container.firstChild.nextSibling);
            }
        }
        
        function hideError() {
            const error = document.getElementById('global-error');
            if (error) {
                error.remove();
            }
        }
        
        function showLoadingState(elementId, message = 'Loading...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `
                    <div class="loading">
                        <div class="loading__spinner" aria-hidden="true"></div>
                        <span class="loading__text">${message}</span>
                    </div>
                `;
            }
        }
        
        // Load recommendations
        async function loadRecommendations() {
            const recommendationsList = document.getElementById('recommendations-list');
            showLoadingState('recommendations-list', 'Analyzing performance...');
            
            try {
                const response = await fetch('/api/analysis');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                const recommendationsList = document.getElementById('recommendations-list');
                
                if (!data.recommendations || data.recommendations.length === 0) {
                    recommendationsList.innerHTML = '<div class="empty-state"><span class="empty-state__text">No recommendations at this time</span></div>';
                    return;
                }
                
                recommendationsList.innerHTML = data.recommendations.map((rec, index) => `
                    <article class="recommendation" role="listitem">
                        <h3 class="recommendation-title">${rec.type.toUpperCase()}</h3>
                        <p class="recommendation-action">${rec.action}</p>
                        <p class="recommendation-impact" aria-label="Expected impact">
                            Impact: ${rec.impact}
                        </p>
                    </article>
                `).join('');
            } catch (error) {
                console.error('Failed to load recommendations:', error);
                recommendationsList.innerHTML = `
                    <div class="error">
                        <span class="error__icon">⚠️</span>
                        <span class="error__message">Failed to load recommendations. Please try again later.</span>
                    </div>
                `;
            }
        }
        
        // Initialize
        connectWebSocket();
        loadRecommendations();
        
        // Refresh recommendations every 5 minutes
        setInterval(loadRecommendations, 300000);
    </script>
</body>
</html>